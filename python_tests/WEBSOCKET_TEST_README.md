# WebSocket SignalR Notification Tests

This directory contains Python scripts to test the WebSocket connection to the SignalR notifications hub and verify that notifications are being sent correctly.

## Files

1. **`websocket_listener.py`** - Standalone WebSocket listener that connects to SignalR hub and logs all messages
2. **`send_notification_test.py`** - Standalone script to send notifications via REST API
3. **`websocket_notification_test.py`** - Comprehensive test that combines both functionalities
4. **`websocket_requirements.txt`** - Python dependencies for WebSocket testing

## Prerequisites

Install the required dependencies:

```bash
pip install -r websocket_requirements.txt
```

## Usage

### Option 1: Separate Scripts (Recommended for debugging)

**Terminal 1 - Start WebSocket Listener:**
```bash
python websocket_listener.py
```

**Terminal 2 - Send Notifications:**
```bash
python send_notification_test.py
```

### Option 2: Combined Test (Recommended for automated testing)

```bash
python websocket_notification_test.py
```

## What Each Script Does

### `websocket_listener.py`
- Connects to the SignalR hub via raw WebSocket
- Sends the required handshake message: `{"protocol":"json","version":1}`
- Listens for all incoming messages
- Logs messages to both console and `websocket_messages.log` file
- Continues listening until interrupted (Ctrl+C)

### `send_notification_test.py`
- Sends direct notifications via REST API
- Creates assignments to trigger assignment notifications
- Sends multiple notifications of different types
- Waits between sends to allow WebSocket processing

### `websocket_notification_test.py`
- Combines both functionalities in a single script
- Establishes WebSocket connection
- Sends notifications via REST API
- Verifies messages are received via WebSocket
- Provides a summary of the test results

## Expected Behavior

1. **WebSocket Connection**: Should establish connection successfully
2. **Handshake**: Should send handshake and receive acknowledgment
3. **Notifications**: When notifications are sent via REST API, they should appear in the WebSocket logs
4. **Message Format**: Messages should be in SignalR JSON format

## Log Files

- `websocket_messages.log` - Generated by `websocket_listener.py`
- `websocket_test.log` - Generated by `websocket_notification_test.py`

## Troubleshooting

### Connection Issues
- Verify the JWT token is valid and not expired
- Check if the SignalR hub is running and accessible
- Ensure CORS is properly configured on the server

### No Messages Received
- Check if notifications are being sent successfully via REST API
- Verify the user ID in the JWT token matches the notification recipient
- Check server logs for any SignalR hub errors

### Handshake Errors
- Verify the handshake message format is correct
- Check if the SignalR protocol version is supported
- Ensure the WebSocket URL is correct

## SignalR Protocol Notes

The scripts use raw WebSocket connections to connect to SignalR hubs. The handshake message follows the SignalR protocol:

```json
{
  "protocol": "json",
  "version": 1
}
```

Messages received will be in SignalR's JSON format, which typically includes:
- Message type indicators
- Method names
- Arguments
- Message IDs

## Security Notes

- The JWT token in the scripts is for testing purposes only
- In production, tokens should be obtained dynamically
- The token contains sensitive user information and should be handled securely 